name: Deploy to Firebase Hosting (Validation)

on:
    workflow_dispatch:
        inputs:
            deploy_online:
                description: 'Deploy online (Firebase)'
                type: boolean
                required: true
                default: true
            deploy_offline:
                description: 'Deploy offline (Firebase)'
                type: boolean
                required: true
                default: true
            deploy_netlify:
                description: 'Deploy offline (Netlify)'
                type: boolean
                required: true
                default: true
            version:
                description: 'Version (e.g., v1.0.0)'
                required: true
                default:
    pull_request:
        types: [opened, synchronize, reopened]

jobs:
    build_and_deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            checks: write
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set default deploy flags for PR
              if: ${{ github.event_name == 'pull_request' }}
              run: |
                  echo "DEPLOY_ONLINE=true" >> $GITHUB_ENV
                  echo "DEPLOY_OFFLINE=true" >> $GITHUB_ENV
                  echo "DEPLOY_NETLIFY=true" >> $GITHUB_ENV

            # ----------------------------------------------------------------
            # 1. Version Handling
            # ----------------------------------------------------------------
            - name: Get Version
              id: get_version
              run: |
                  if [ "${GITHUB_EVENT_NAME}" == "pull_request" ]; then
                    APP_VERSION="pr-${GITHUB_EVENT_NUMBER}-${GITHUB_SHA::8}"
                  else
                    APP_VERSION="${{ inputs.version }}"
                  fi
                  echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV

            - name: Install Dependencies
              run: npm ci

            # ----------------------------------------------------------------
            # 2. Check & Validate Secrets
            # ----------------------------------------------------------------
            - name: Check & Validate Secrets
              id: check_secrets
              run: |
                  # Initialize status
                  ONLINE_OK="true"
                  OFFLINE_OK="true"
                  NETLIFY_OK="true"

                  echo "üîç Starting Secret Validation..."

                  # --- A. Check Online Required Secrets ---
                  if [ "${{ inputs.deploy_online }}" == "true" ]; then
                    # 1. Check Firebase Service Account
                    if [ -z "${{ secrets.FIREBASE_SERVICE_ACCOUNT_MAPLIO }}" ]; then
                      echo "‚ùå Missing Secret: FIREBASE_SERVICE_ACCOUNT_MAPLIO"
                      ONLINE_OK="false"
                    fi
                    
                    # 2. Check VITE Keys (Required for Build)
                    if [ -z "${{ secrets.VITE_FIREBASE_API_KEY }}" ]; then
                      echo "‚ùå Missing Secret: VITE_FIREBASE_API_KEY"
                      ONLINE_OK="false"
                    fi
                    if [ -z "${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}" ]; then
                      echo "‚ùå Missing Secret: VITE_FIREBASE_AUTH_DOMAIN"
                      ONLINE_OK="false"
                    fi
                    if [ -z "${{ secrets.VITE_FIREBASE_PROJECT_ID }}" ]; then
                      echo "‚ùå Missing Secret: VITE_FIREBASE_PROJECT_ID"
                      ONLINE_OK="false"
                    fi
                    if [ -z "${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}" ]; then
                      echo "‚ùå Missing Secret: VITE_FIREBASE_STORAGE_BUCKET"
                      ONLINE_OK="false"
                    fi
                    if [ -z "${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}" ]; then
                      echo "‚ùå Missing Secret: VITE_FIREBASE_MESSAGING_SENDER_ID"
                      ONLINE_OK="false"
                    fi
                    if [ -z "${{ secrets.VITE_FIREBASE_APP_ID }}" ]; then
                      echo "‚ùå Missing Secret: VITE_FIREBASE_APP_ID"
                      ONLINE_OK="false"
                    fi
                  fi

                  # --- B. Check Offline Required Secrets ---
                  if [ "${{ inputs.deploy_offline }}" == "true" ]; then
                    if [ -z "${{ secrets.FIREBASE_SERVICE_ACCOUNT_MAPLIO_OFFLINE }}" ]; then
                      echo "‚ùå Missing Secret: FIREBASE_SERVICE_ACCOUNT_MAPLIO_OFFLINE"
                      OFFLINE_OK="false"
                    fi
                    if [ -z "${{ secrets.VITE_FIREBASE_PROJECT_ID_OFFLINE }}" ]; then
                      echo "‚ùå Missing Secret: VITE_FIREBASE_PROJECT_ID_OFFLINE"
                      OFFLINE_OK="false"
                    fi
                  fi

                  # --- C. Check Netlify Required Secrets ---
                  if [ "${{ inputs.deploy_netlify }}" == "true" ]; then
                    if [ -z "${{ secrets.NETLIFY_AUTH_TOKEN }}" ]; then
                        echo "‚ùå Missing Secret: NETLIFY_AUTH_TOKEN"
                        NETLIFY_OK="false"
                    fi
                    if [ -z "${{ secrets.NETLIFY_SITE_ID }}" ]; then
                        echo "‚ùå Missing Secret: NETLIFY_SITE_ID"
                        NETLIFY_OK="false"
                    fi
                  fi

                  # Output results for subsequent steps
                  echo "online_ok=$ONLINE_OK" >> $GITHUB_OUTPUT
                  echo "offline_ok=$OFFLINE_OK" >> $GITHUB_OUTPUT
                  echo "netlify_ok=$NETLIFY_OK" >> $GITHUB_OUTPUT

                  echo "‚úÖ Validation Complete. Online: $ONLINE_OK, Offline: $OFFLINE_OK, Netlify: $NETLIFY_OK"

            # ----------------------------------------------------------------
            # 3. Online Build & Deployment (Firebase)
            # ----------------------------------------------------------------
            - name: Build for Online
              # Execute only if deploy_online is true AND secrets check passed (ONLINE_OK=true)
              if: ${{ (env.DEPLOY_ONLINE == 'true' || inputs.deploy_online == true) && steps.check_secrets.outputs.online_ok == 'true' }}
              run: npm run build
              env:
                  VITE_APP_VERSION: ${{ env.APP_VERSION }}
                  # Inject all Firebase environment variables (Used during Build)
                  VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
                  VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
                  VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
                  VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
                  VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
                  VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}

            - name: Online Deploy to Firebase
              if: ${{ (env.DEPLOY_ONLINE == 'true' || inputs.deploy_online == true) && steps.check_secrets.outputs.online_ok == 'true' }}
              uses: FirebaseExtended/action-hosting-deploy@v0
              with:
                  repoToken: '${{ secrets.GITHUB_TOKEN }}'
                  firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_MAPLIO }}'
                  channelId: ${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || 'preview-manual' }}
                  expires: 1d
                  projectId: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}

            - name: Skip Online Deploy
              if: ${{ (env.DEPLOY_ONLINE == 'true' || inputs.deploy_online == true) && steps.check_secrets.outputs.online_ok == 'false' }}
              run: |
                  echo "‚ö†Ô∏è Firebase online deployment skipped due to missing secrets."

            # ----------------------------------------------------------------
            # 4. Offline Build & Deployment (Firebase / Netlify / GitHub Release Zip)
            # ----------------------------------------------------------------
            - name: Build for Offline
              run: |
                  npm run build:offline
                  rm -rf dist
                  cp -r dist-offline dist
              env:
                  VITE_APP_MODE: offline
                  VITE_APP_VERSION: ${{ env.APP_VERSION }}

            - name: Offline Deploy to Firebase
              if: ${{ (env.DEPLOY_OFFLINE == 'true' || inputs.deploy_offline == true) && steps.check_secrets.outputs.offline_ok == 'true' }}
              uses: FirebaseExtended/action-hosting-deploy@v0
              with:
                  repoToken: '${{ secrets.GITHUB_TOKEN }}'
                  firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_MAPLIO_OFFLINE }}'
                  channelId: ${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || 'preview-manual' }}
                  expires: 1d
                  projectId: ${{ secrets.VITE_FIREBASE_PROJECT_ID_OFFLINE }}

            - name: Skip Offline Deploy
              if: ${{ (env.DEPLOY_OFFLINE == 'true' || inputs.deploy_offline == true) && steps.check_secrets.outputs.offline_ok == 'false' }}
              run: |
                  echo "‚ö†Ô∏è Firebase offline deployment skipped due to missing secrets."

            - name: Offline Deploy to Netlify
              if: ${{ (env.DEPLOY_NETLIFY== 'true' || inputs.deploy_netlify == true) && steps.check_secrets.outputs.netlify_ok == 'true' }}
              uses: nwtgck/actions-netlify@v3.0
              with:
                  publish-dir: './dist-offline'
                  production-branch: main
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  github-deployment-environment: pr-${{ github.event.pull_request.number }}
                  deploy-message: 'Deploy v${{ env.APP_VERSION }} from GitHub Actions'
                  enable-pull-request-comment: false
                  enable-commit-comment: false
                  overwrites-pull-request-comment: false
              env:
                  NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
                  NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

            - name: Skip Netlify Deploy
              if: ${{ (env.DEPLOY_NETLIFY== 'true' || inputs.deploy_netlify == true) && steps.check_secrets.outputs.netlify_ok == 'false' }}
              run: echo "‚ö†Ô∏è Netlify offline deployment skipped due to missing secrets."
